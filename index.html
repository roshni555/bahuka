<?php

include_once "gppa-common.php";

/**
 * @file
 * Contains the theme's functions to manipulate Drupal's default markup.
 *
 * A QUICK OVERVIEW OF DRUPAL THEMING
 *
 *   The default HTML for all of Drupal's markup is specified by its modules.
 *   For example, the comment.module provides the default HTML markup and CSS
 *   styling that is wrapped around each comment. Fortunately, each piece of
 *   markup can optionally be overridden by the theme.
 *
 *   Drupal deals with each chunk of content using a "theme hook". The raw
 *   content is placed in PHP variables and passed through the theme hook, which
 *   can either be a template file (which you should already be familiary with)
 *   or a theme function. For example, the "comment" theme hook is implemented
 *   with a comment.tpl.php template file, but the "breadcrumb" theme hooks is
 *   implemented with a theme_breadcrumb() theme function. Regardless if the
 *   theme hook uses a template file or theme function, the template or function
 *   does the same kind of work; it takes the PHP variables passed to it and
 *   wraps the raw content with the desired HTML markup.
 *
 *   Most theme hooks are implemented with template files. Theme hooks that use
 *   theme functions do so for performance reasons - theme_field() is faster
 *   than a field.tpl.php - or for legacy reasons - theme_breadcrumb() has "been
 *   that way forever."
 *
 *   The variables used by theme functions or template files come from a handful
 *   of sources:
 *   - the contents of other theme hooks that have already been rendered into
 *     HTML. For example, the HTML from theme_breadcrumb() is put into the
 *     $breadcrumb variable of the page.tpl.php template file.
 *   - raw data provided directly by a module (often pulled from a database)
 *   - a "render element" provided directly by a module. A render element is a
 *     nested PHP array which contains both content and meta data with hints on
 *     how the content should be rendered. If a variable in a template file is a
 *     render element, it needs to be rendered with the render() function and
 *     then printed using:
 *       <?php print render($variable); ?>
 *
 * ABOUT THE TEMPLATE.PHP FILE
 *
 *   The template.php file is one of the most useful files when creating or
 *   modifying Drupal themes. With this file you can do three things:
 *   - Modify any theme hooks variables or add your own variables, using
 *     preprocess or process functions.
 *   - Override any theme function. That is, replace a module's default theme
 *     function with one you write.
 *   - Call hook_*_alter() functions which allow you to alter various parts of
 *     Drupal's internals, including the render elements in forms. The most
 *     useful of which include hook_form_alter(), hook_form_FORM_ID_alter(),
 *     and hook_page_alter(). See api.drupal.org for more information about
 *     _alter functions.
 *
 * OVERRIDING THEME FUNCTIONS
 *
 *   If a theme hook uses a theme function, Drupal will use the default theme
 *   function unless your theme overrides it. To override a theme function, you
 *   have to first find the theme function that generates the output. (The
 *   api.drupal.org website is a good place to find which file contains which
 *   function.) Then you can copy the original function in its entirety and
 *   paste it in this template.php file, changing the prefix from theme_ to
 *   STARTERKIT_. For example:
 *
 *     original, found in modules/field/field.module: theme_field()
 *     theme override, found in template.php: STARTERKIT_field()
 *
 *   where STARTERKIT is the name of your sub-theme. For example, the
 *   zen_classic theme would define a zen_classic_field() function.
 *
 *   Note that base themes can also override theme functions. And those
 *   overrides will be used by sub-themes unless the sub-theme chooses to
 *   override again.
 *
 *   Zen core only overrides one theme function. If you wish to override it, you
 *   should first look at how Zen core implements this function:
 *     theme_breadcrumbs()      in zen/template.php
 *
 *   For more information, please visit the Theme Developer's Guide on
 *   Drupal.org: http://drupal.org/node/173880
 *
 * CREATE OR MODIFY VARIABLES FOR YOUR THEME
 *
 *   Each tpl.php template file has several variables which hold various pieces
 *   of content. You can modify those variables (or add new ones) before they
 *   are used in the template files by using preprocess functions.
 *
 *   This makes THEME_preprocess_HOOK() functions the most powerful functions
 *   available to themers.
 *
 *   It works by having one preprocess function for each template file or its
 *   derivatives (called theme hook suggestions). For example:
 *     THEME_preprocess_page    alters the variables for page.tpl.php
 *     THEME_preprocess_node    alters the variables for node.tpl.php or
 *                              for node--forum.tpl.php
 *     THEME_preprocess_comment alters the variables for comment.tpl.php
 *     THEME_preprocess_block   alters the variables for block.tpl.php
 *
 *   For more information on preprocess functions and theme hook suggestions,
 *   please visit the Theme Developer's Guide on Drupal.org:
 *   http://drupal.org/node/223440 and http://drupal.org/node/1089656
 */
/**
 * Override or insert variables into the maintenance page template.
 *
 * @param $variables
 *   An array of variables to pass to the theme template.
 * @param $hook
 *   The name of the template being rendered ("maintenance_page" in this case.)
 */
/* -- Delete this line if you want to use this function
  function STARTERKIT_preprocess_maintenance_page(&$variables, $hook) {
  // When a variable is manipulated or added in preprocess_html or
  // preprocess_page, that same work is probably needed for the maintenance page
  // as well, so we can just re-use those functions to do that work here.
  STARTERKIT_preprocess_html($variables, $hook);
  STARTERKIT_preprocess_page($variables, $hook);
  }
  // */

/**
 * Override or insert variables into the html templates.
 *
 * @param $variables
 *   An array of variables to pass to the theme template.
 * @param $hook
 *   The name of the template being rendered ("html" in this case.)
 */
/* -- Delete this line if you want to use this function
  function STARTERKIT_preprocess_html(&$variables, $hook) {
  $variables['sample_variable'] = t('Lorem ipsum.');

  // The body tag's classes are controlled by the $classes_array variable. To
  // remove a class from $classes_array, use array_diff().
  //$variables['classes_array'] = array_diff($variables['classes_array'], array('class-to-remove'));
  }
  // */

/**
 * Override or insert variables into the page templates.
 *
 * @param $variables
 *   An array of variables to pass to the theme template.
 * @param $hook
 *   The name of the template being rendered ("page" in this case.)
 */
function startsWith($needle, $haystack) {
    return preg_match('/^' . preg_quote($needle, '/') . '/', $haystack);
}

function endsWith($needle, $haystack) {
    return preg_match('/' . preg_quote($needle, '/') . '$/', $haystack);
}

//function gppa_theme(&$existing, $type, $theme, $path) {
//    $hooks = zen_theme($existing, $type, $theme, $path);
//    $hooks['user_login'] = array(
//        'template' => 'user-login',
//        'arguments' => array('form' => NULL)
//    );
//    return $hooks;
//}

function gppa_preprocess_page(&$variables, $hook) {
    //dpm($variables);
    $trail = menu_get_active_trail();
    //dpm($trail);

    if ($variables['is_front']) {
        drupal_add_js(path_to_theme() . "/js/frontpage.js");
    }

    $uri = $_ENV["REQUEST_URI"];

    if (isset($trail[2], $trail[1]['mlid']) && $trail[1]['mlid'] == 910) {
        $variables['program'] = array(
            'title' => $trail[2]['title'],
            'description' => $trail[2]['description']);
    } else if (isset($trail[1]['mlid']) && $trail[1]['mlid'] == 410) {
        $variables['program'] = array(
            'title' => "Members Area", //$trail[1]['title'],
            'description' => $trail[1]['description']);
//    } else if(startsWith("/book", $uri)){
////        dpm($_REQUEST["event"]);
    } else if (startsWith("/events", $uri)) {
        $variables['program'] = array(
            'title' => "Upcoming Events", //$trail[1]['title'],
            'description' => $trail[1]['description']);
        $trail[] = array('title' => 'Upcoming events', 'href' => '/events', 'link_path' => '', 'localized_options' => '', 'type' => 0);
        menu_set_active_trail($trail);
//        dpm($trail);
    } else if (startsWith("/store", $uri)) {
        $variables['program'] = array(
            'title' => "Publications", //$trail[1]['title'],
            'description' => $trail[1]['description']);
        $trail[] = array('title' => 'Publications', 'href' => '/store', 'link_path' => '', 'localized_options' => '', 'type' => 0);
        menu_set_active_trail($trail);
////        dpm($trail);
//    }  else if (startsWith("/user/login", $uri)) {
//
//        $variables['program'] = array(
//            'title' => "Member Login", //$trail[1]['title'],
//            'description' => $trail[1]['description']);
//        
    } else if (isset($trail[1]['title'])) {
        if ($trail[1]['title'] != "Home") {
            $variables['program'] = array(
                'title' => $trail[1]['title'],
                'description' => $trail[1]['description']);
        }
    }
    $variables['trail'] = $trail;

    if (startsWith("/resources", $uri)) {
        drupal_add_js(path_to_theme() . '/js/accordion.js');
    }
//    if(isset($variables['node']->field_program['und'][0]['tid'])){
//        $program = entity_load('taxonomy_term',(array)$variables['node']->field_program['und'][0]['tid']);
//        if(isset($program[$variables['node']->field_program['und'][0]['tid']])){
//            $program = $program[$variables['node']->field_program['und'][0]['tid']];
////            dpm($program);
//            $variables['program'] = $program;
//        }
//    }
//    dpm( );
//    dpm(menu_tree_page_data("main-menu", 2, TRUE));
//  $variables['sample_variable'] = t('Lorem ipsum.');

    if (isset($_GET['ref']) && $_GET['ref'] === 'adelaide') {
        //drupal_add_js(path_to_theme() . '/js/jquery.ui.dialog.min.js');
        drupal_add_library('system', 'ui.dialog');
        drupal_add_js(path_to_theme() . '/js/adelaide.js');
    }
}

// */

/**
 * Override or insert variables into the node templates.
 *
 * @param $variables
 *   An array of variables to pass to the theme template.
 * @param $hook
 *   The name of the template being rendered ("node" in this case.)
 */
function gppa_preprocess_node(&$variables, $hook) {
    //$variables['sample_variable'] = t('Lorem ipsum.');
    // Optionally, run node-type-specific preprocess functions, like
    // STARTERKIT_preprocess_node_page() or STARTERKIT_preprocess_node_story().
    $function = __FUNCTION__ . '_' . $variables['node']->type;
    if (function_exists($function)) {
        $function($variables, $hook);
    }
}

function gppa_preprocess_node_product(&$variables, $hook) {

    //dpm($variables);
    $list_price = db_query("SELECT list_price FROM {uc_products} WHERE nid = :nid", array(':nid' => $variables['node']->nid))->fetchField();
    $variables['var_regular_price'] = $list_price * 1.1;

    $digital_adjust = db_query("SELECT price FROM {uc_product_options} WHERE nid = :nid AND oid = :oid", array(':nid' => $variables['node']->nid, ':oid' => 3))->fetchField();
    if ($digital_adjust !== FALSE && is_numeric($digital_adjust)) {
        $variables['var_digital_price'] = (floatval($list_price) + floatval($digital_adjust)) * 1.1;
    }
    //if ($list_price !== FALSE) {
    $member_price = db_query("SELECT price FROM {uc_price_per_role_prices} WHERE nid = :nid AND :rid", array(':nid' => $variables['node']->nid, ':rid' => 6))->fetchField();
    if ($member_price !== FALSE) {
        $variables['var_member_price'] = $member_price * 1.1;
        if (isset($variables['var_digital_price'])) {
            $digital_member_adjust = db_query("SELECT price FROM {uc_price_per_role_option_prices} WHERE nid = :nid AND oid = :oid AND :rid", array(':nid' => $variables['node']->nid, ':oid' => 3, ':rid' => 6))->fetchField();
            if ($digital_member_adjust !== FALSE && is_numeric($digital_member_adjust)) {
                $variables['var_digital_member_price'] = (floatval($member_price) + floatval($digital_member_adjust)) * 1.1;
            } else {
                $variables['var_digital_member_price'] = (floatval($member_price) + floatval($digital_adjust)) * 1.1;
            }
        }
    }
    
    
    
    

    //}
}

// */

/**
 * Override or insert variables into the comment templates.
 *
 * @param $variables
 *   An array of variables to pass to the theme template.
 * @param $hook
 *   The name of the template being rendered ("comment" in this case.)
 */
/* -- Delete this line if you want to use this function
  function STARTERKIT_preprocess_comment(&$variables, $hook) {
  $variables['sample_variable'] = t('Lorem ipsum.');
  }
  // */

/**
 * Override or insert variables into the region templates.
 *
 * @param $variables
 *   An array of variables to pass to the theme template.
 * @param $hook
 *   The name of the template being rendered ("region" in this case.)
 */
/* -- Delete this line if you want to use this function
  function STARTERKIT_preprocess_region(&$variables, $hook) {
  // Don't use Zen's region--sidebar.tpl.php template for sidebars.
  //if (strpos($variables['region'], 'sidebar_') === 0) {
  //  $variables['theme_hook_suggestions'] = array_diff($variables['theme_hook_suggestions'], array('region__sidebar'));
  //}
  }
  // */

/**
 * Override or insert variables into the block templates.
 *
 * @param $variables
 *   An array of variables to pass to the theme template.
 * @param $hook
 *   The name of the template being rendered ("block" in this case.)
 */
/* -- Delete this line if you want to use this function
  function STARTERKIT_preprocess_block(&$variables, $hook) {
  // Add a count to all the blocks in the region.
  // $variables['classes_array'][] = 'count-' . $variables['block_id'];

  // By default, Zen will use the block--no-wrapper.tpl.php for the main
  // content. This optional bit of code undoes that:
  //if ($variables['block_html_id'] == 'block-system-main') {
  //  $variables['theme_hook_suggestions'] = array_diff($variables['theme_hook_suggestions'], array('block__no_wrapper'));
  //}
  }
  // */


function gppa_superfish_build($variables) {
    $output = array('content' => '');
    $id = $variables['id'];
    $menu = $variables['menu'];
    $depth = $variables['depth'];

    //custom gppa thing
    //dpm($variables);



    $trail = $variables['trail'];
    // Keep $sfsettings untouched as we need to pass it to the child menus.
    $settings = $sfsettings = $variables['sfsettings'];
    $megamenu = $settings['megamenu'];
    $total_children = $parent_children = $single_children = 0;
    $i = 1;

    // Reckon the total number of available menu items.
    foreach ($menu as $menu_item) {
        if (!isset($menu_item['link']['hidden']) || $menu_item['link']['hidden'] == 0) {
            $total_children++;
        }
    }

    foreach ($menu as $menu_item) {

        $show_children = $megamenu_wrapper = $megamenu_column = $megamenu_content = FALSE;
        $item_class = $link_options = $link_class = array();
        $mlid = $menu_item['link']['mlid'];

        if (!isset($menu_item['link']['hidden']) || $menu_item['link']['hidden'] == 0) {
            $item_class[] = ($trail && in_array($mlid, $trail)) ? 'active-trail' : '';

            // Add helper classes to the menu items and hyperlinks.
            $settings['firstlast'] = ($settings['dfirstlast'] == 1 && $total_children == 1) ? 0 : $settings['firstlast'];
            $item_class[] = ($settings['firstlast'] == 1) ? (($i == 1) ? 'first' : (($i == $total_children) ? 'last' : 'middle')) : '';
            $settings['zebra'] = ($settings['dzebra'] == 1 && $total_children == 1) ? 0 : $settings['zebra'];
            $item_class[] = ($settings['zebra'] == 1) ? (($i % 2) ? 'odd' : 'even') : '';
            $item_class[] = ($settings['itemcount'] == 1) ? 'sf-item-' . $i : '';
            $item_class[] = ($settings['itemdepth'] == 1) ? 'sf-depth-' . $menu_item['link']['depth'] : '';
            $link_class[] = ($settings['itemdepth'] == 1) ? 'sf-depth-' . $menu_item['link']['depth'] : '';
            $item_class[] = ($settings['liclass']) ? $settings['liclass'] : '';
            if (strpos($settings['hlclass'], ' ')) {
                $l = explode(' ', $settings['hlclass']);
                foreach ($l as $c) {
                    $link_class[] = $c;
                }
            } else {
                $link_class[] = $settings['hlclass'];
            }
            $i++;

            // Add hyperlinks description (title) to their text.
            $show_linkdescription = ($settings['linkdescription'] == 1 && !empty($menu_item['link']['localized_options']['attributes']['title'])) ? TRUE : FALSE;
            if ($show_linkdescription) {
                if (!empty($settings['hldmenus'])) {
                    $show_linkdescription = (is_array($settings['hldmenus'])) ? ((in_array($mlid, $settings['hldmenus'])) ? TRUE : FALSE) : (($mlid == $settings['hldmenus']) ? TRUE : FALSE);
                }
                if (!empty($settings['hldexclude'])) {
                    $show_linkdescription = (is_array($settings['hldexclude'])) ? ((in_array($mlid, $settings['hldexclude'])) ? FALSE : $show_linkdescription) : (($settings['hldexclude'] == $mlid) ? FALSE : $show_linkdescription);
                }
                if ($show_linkdescription) {
                    $menu_item['link']['title'] .= '<span class="sf-description">';
                    $menu_item['link']['title'] .= (!empty($menu_item['link']['localized_options']['attributes']['title'])) ? $menu_item['link']['localized_options']['attributes']['title'] : array();
                    $menu_item['link']['title'] .= '</span>';
                    $link_options['html'] = TRUE;
                }
            }

            // Add custom HTML codes around the menu items.
            if ($sfsettings['wrapul'] && strpos($sfsettings['wrapul'], ',') !== FALSE) {
                $wul = explode(',', $sfsettings['wrapul']);
                // In case you just wanted to add something after the element.
                if (drupal_substr($sfsettings['wrapul'], 0) == ',') {
                    array_unshift($wul, '');
                }
            } else {
                $wul = array();
            }

            // Add custom HTML codes around the hyperlinks.
            if ($settings['wraphl'] && strpos($settings['wraphl'], ',') !== FALSE) {
                $whl = explode(',', $settings['wraphl']);
                // The same as above
                if (drupal_substr($settings['wraphl'], 0) == ',') {
                    array_unshift($whl, '');
                }
            } else {
                $whl = array();
            }

            // Add custom HTML codes around the hyperlinks text.
            if ($settings['wraphlt'] && strpos($settings['wraphlt'], ',') !== FALSE) {
                $whlt = explode(',', $settings['wraphlt']);
                // The same as above
                if (drupal_substr($settings['wraphlt'], 0) == ',') {
                    array_unshift($whlt, '');
                }
                $menu_item['link']['title'] = $whlt[0] . check_plain($menu_item['link']['title']) . $whlt[1];
                $link_options['html'] = TRUE;
            }


            if (!empty($menu_item['link']['has_children']) && !empty($menu_item['below']) && $depth != 0) {
                // Megamenu is still beta, there is a good chance much of this will be changed.
                if (!empty($settings['megamenu_exclude'])) {
                    if (is_array($settings['megamenu_exclude'])) {
                        $megamenu = (in_array($mlid, $settings['megamenu_exclude'])) ? 0 : $megamenu;
                    } else {
                        $megamenu = ($settings['megamenu_exclude'] == $mlid) ? 0 : $megamenu;
                    }
                    // Send the result to the sub-menu.
                    $sfsettings['megamenu'] = $megamenu;
                }
                if ($megamenu == 1) {
                    $megamenu_wrapper = ($menu_item['link']['depth'] == $settings['megamenu_depth']) ? TRUE : FALSE;
                    $megamenu_column = ($menu_item['link']['depth'] == $settings['megamenu_depth'] + 1) ? TRUE : FALSE;
                    $megamenu_content = ($menu_item['link']['depth'] >= $settings['megamenu_depth'] && $menu_item['link']['depth'] <= $settings['megamenu_levels']) ? TRUE : FALSE;
                }

                $ch_depth = $depth;
                $override_depth = db_query('SELECT g.depth FROM {gppa_sfmenu_depth} g WHERE g.mlid = :mlid', array(':mlid' => $mlid))->fetchField();
                if ($override_depth) {
                    //dpm("SETTING to " . $override_depth);
                    $ch_depth = $override_depth;
                }

                // Render the sub-menu.
                $var = array(
                    'id' => $id,
                    'menu' => $menu_item['below'],
                    'depth' => $ch_depth, 'trail' => $trail,
                    'sfsettings' => $sfsettings
                );
                $children = theme('superfish_build', $var);

                // Check to see whether it should be displayed.
                $show_children = (($menu_item['link']['depth'] <= $ch_depth || $ch_depth == -1) && $children['content']) ? TRUE : FALSE;




                if ($show_children) {
                    // Add item counter classes.
                    if ($settings['itemcounter']) {
                        $item_class[] = 'sf-total-children-' . $children['total_children'];
                        $item_class[] = 'sf-parent-children-' . $children['parent_children'];
                        $item_class[] = 'sf-single-children-' . $children['single_children'];
                    }
                    // More helper classes.
                    $item_class[] = ($megamenu_column) ? 'sf-megamenu-column' : '';
                    $item_class[] = $link_class[] = 'menuparent';
                }
                $parent_children++;
            } else {
                $item_class[] = 'sf-no-children';
                $single_children++;
            }



            $menu_item['link']['localized_options']['attributes']['class'] = $link_class;

            $link_options['attributes'] = $menu_item['link']['localized_options']['attributes'];

            $link_title = $menu_item['link']['title'];
//      dpm($depth);
            if ($menu_item['link']['depth'] == 1) {
                $link_options['html'] = TRUE;
                $link_options['attributes']['class'][] = 'menu_item_link';
                $link_title = "<div class=\"menu_item_title\">" . $menu_item['link']['title'] . "</div><div class=\"menu_item_desc\">" . $link_options['attributes']['title'] . "</div>";
//          $link = l("<div class=\"menu_item_title\">".$menu_item['link']['title']."</div><div class=\"menu_item_desc\">".$link_options['attributes']['title']."</div>", $menu_item['link']['link_path'], $link_options);
                if ($i == 2) {
                    $item_class[] = "menu_item_first";
                }
            }
            if ($menu_item['link']['link_path'] == "<nolink>") {
                $link = "<div class=\"nolink " . implode(' ', array_filter($link_options['attributes']["class"])) . "\">$link_title</div>"; //l($link_title, "#", $link_options);
            } else if (preg_match("/gppa_menu\/node\/(\d+)/", $menu_item['link']['link_path'], $matches)) {
                
                $nid = $matches[1];
                
                $menu_item['link']['localized_options']['attributes']['class'][] = 'menu_node';
                $menu_item['link']['localized_options']['attributes']['class'][] = 'menu_node_' . $nid;

//                $link =  '<li' . drupal_attributes($menu_item['link']['localized_options']['attributes']) . '>' . p2div(fv(node_load($nid),'body','','value',0,'')) . "</li>\n";
                $node = node_load($nid);
                $link = fv($node, 'body', '', 'value', 0, '');
            } else {
                $link = l($link_title, $menu_item['link']['link_path'], $link_options);
            }



            $item_class = implode(' ', array_filter($item_class));

            if (isset($menu_item['link']['localized_options']['attributes']['class'])) {
                $link_class_current = $menu_item['link']['localized_options']['attributes']['class'];
                $link_class = array_merge($link_class_current, array_filter($link_class));
            }
//      dpm($link_options['attributes']['title']);
            // Render the menu item.
            $output['content'] .= '<li id="menu-' . $mlid . '-' . $id . '"';
            $output['content'] .= ($item_class) ? ' class="' . ($menu_item['link']['depth'] == 1 ? "menu_item " : "") . trim($item_class) . '">' : '>';
            $output['content'] .= ($megamenu_column) ? '<div class="sf-megamenu-column">' : '';
            $output['content'] .= isset($whl[0]) ? $whl[0] : '';
            $output['content'] .= $link;
            $output['content'] .= isset($whl[1]) ? $whl[1] : '';
            $output['content'] .= ($megamenu_wrapper) ? '<ul class="sf-megamenu"><li class="sf-megamenu-wrapper ' . $item_class . '">' : '';
            $output['content'] .= ($show_children) ? (isset($wul[0]) ? $wul[0] : '') : '';
            $output['content'] .= ($show_children) ? (($megamenu_content) ? '<ol>' : '<ul>') : '';
            $output['content'] .= ($show_children) ? $children['content'] : '';
            $output['content'] .= ($show_children) ? (($megamenu_content) ? '</ol>' : '</ul>') : '';
            $output['content'] .= ($show_children) ? (isset($wul[1]) ? $wul[1] : '') : '';
            $output['content'] .= ($megamenu_wrapper) ? '</li></ul>' : '';
            $output['content'] .= ($megamenu_column) ? '</div>' : '';
            $output['content'] .= '</li>';
        }
    }
    $output['total_children'] = $total_children;
    $output['parent_children'] = $parent_children;
    $output['single_children'] = $single_children;
    return $output;
}

function gppa_query_alter(&$query) {
    if ($query->hasTag('news_archive')) {
//        dpm($query);
        $query->groupBy("DATE_FORMAT(FROM_UNIXTIME(node.created),'%Y-%m')");
//        unset($query->alterMetaData["view"]->built);
//        $query->alterMetaData["view"]->build();
//        dpm($query);
//        dpm($query->alterMetaData["view"]->query)
//        $query->alterMetaData["view"]->query->groupby[] = array("field"=>"raw_sql_field");
    }
}

function gppa_menu() {
    $items['gppa_menu/node/%'] = array(
        'page callback' => 'drupal_not_found',
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );


    return $items;
}

//function gppa_pager_link($variables) {
//  $text = $variables['text'];
//  $page_new = $variables['page_new'];
//  $element = $variables['element'];
//  $parameters = $variables['parameters'];
//  $attributes = $variables['attributes'];
//
//  $page = isset($_GET['page']) ? $_GET['page'] : '';
//  if ($new_page = implode(',', pager_load_array($page_new[$element], $element, explode(',', $page)))) {
//    $parameters['page'] = $new_page;
//  }
//
//  $query = array();
//  if (count($parameters)) {
//    $query = drupal_get_query_parameters($parameters, array());
//  }
//  if ($query_pager = pager_get_query_parameters()) {
//    $query = array_merge($query, $query_pager);
//  }
//
//  // Set each pager link title
//  if (!isset($attributes['title'])) {
//    static $titles = NULL;
//    if (!isset($titles)) {
//      $titles = array(
//        t('« first') => t('Go to first page'),
//        t('‹ previous') => t('Go to previous page'),
//        t('next ›') => t('Go to next page'),
//        t('last »') => t('Go to last page'),
//      );
//    }
//    if (isset($titles[$text])) {
//      $attributes['title'] = $titles[$text];
//    }
//    elseif (is_numeric($text)) {
//      $attributes['title'] = t('Go to page @number', array('@number' => $text));
//    }
//  }
//
//  // @todo l() cannot be used here, since it adds an 'active' class based on the
//  //   path only (which is always the current path for pager links). Apparently,
//  //   none of the pager links is active at any time - but it should still be
//  //   possible to use l() here.
//  // @see http://drupal.org/node/1410574
//  dpm($query);
//  dpm($_GET['q']);
//  dpm($attributes);
//  
//  $attributes['href'] = url($_GET['q'], array('query' => $query));
//  return '<a' . drupal_attributes($attributes) . '>' . check_plain($text) . '</a>';
//}
//function gppa_form_element_label($variables) {
//  $element = $variables['element'];
//  // This is also used in the installer, pre-database setup.
//  $t = get_t();
//  
////  dpm($element);
//
//  // If title and required marker are both empty, output no label.
//  if ((!isset($element['#title']) || $element['#title'] === '') && empty($element['#required'])) {
//    return '';
//  }
//
//  // If the element is required, a required marker is appended to the label.
//  $required = !empty($element['#required']) ? theme('form_required_marker', array('element' => $element)) : '';
//
//  $title = filter_xss_admin($element['#title']);
//
//  $attributes = array();
//  // Style the label as class option to display inline with the element.
//  if ($element['#title_display'] == 'after') {
//    $attributes['class'] = 'option';
//  }
//  // Show label only to screen readers to avoid disruption in visual flows.
//  elseif ($element['#title_display'] == 'invisible') {
//    $attributes['class'] = 'element-invisible';
//  }
//
//  if (!empty($element['#id'])) {
//    $attributes['for'] = $element['#id'];
//  }
//
//  // The leading whitespace helps visually separate fields from inline labels.
//  return ' <span' . drupal_attributes($attributes) . '>' . $t('!title !required', array('!title' => $title, '!required' => $required)) . " : </span>\n";
//} 
//function gppa_html_head_alter(&$head_elements) {
//    if (isset($_GET['ref']) && $_GET['ref'] === 'adelaide') {
//        $uri = substr($_SERVER['REQUEST_URI'], 0, strpos($_SERVER['REQUEST_URI'], '?'));
//        $found = false;
//        foreach ($head_elements as $key => $element) {
//            if (isset($element['#attributes']['rel']) && $element['#attributes']['rel'] == 'canonical') {
//                $head_elements[$key]['#attributes']['href'] = $_SERVER['HTTP_HOST'] . $uri;
//                $found = true;
//                break;
//            }
//        }
//        if (!$found) {
//            $element = array(
//                '#tag' => 'link', // The #tag is the html tag - <link />
//                '#attributes' => array(// Set up an array of attributes inside the tag
//                    'href' => $_SERVER['HTTP_HOST'] . $uri,
//                    'rel' => 'canonical',
//                ),
//            );
//            drupal_add_html_head($element, 'canonical');
//        }
//    }
//}

function gppa_uc_file_user_downloads($variables) {
    $header = array(
        array('data' => 'Purchased', 'field' => 'u.granted', 'sort' => 'desc', 'class' => array('purchased-field-header')),
        array('data' => 'Filename', 'field' => 'u.filename', 'class' => array('filename-field-header'))
    );
    $files = $variables['files'];

    $rows = array();
    $row = 0;
    foreach ($files as $file) {
        $rows[] = array(
            array('data' => format_date($file['granted'], 'uc_store'), 'class' => array('date-row'), 'id' => 'date-' . $row),
            array('data' => $file['link'], 'class' => array('filename-row'), 'id' => 'filename-' . $row),
                //array('data' => $file['description'], 'class' => array('description-row'), 'id' => 'description-' . $row),
                //array('data' => $file['accessed'] . '/' . ($file['download_limit'] ? $file['download_limit'] : t('Unlimited')), 'class' => array('download-row'), 'id' => 'download-' . $row),
                //array('data' => count(unserialize($file['addresses'])) . '/' . ($file['address_limit'] ? $file['address_limit'] : t('Unlimited')), 'class' => array('addresses-row'), 'id' => 'addresses-' . $row),
        );
        $row++;
    }

    $output = theme('table', array(
        'header' => $header,
        'rows' => $rows,
        'empty' => t('No downloads found'),
        'attributes' => array(
            'class' => array('user-download-table')
        )
    ));
    $output .= theme('pager');
    $output .= '<div class="form-item"><p class="description">' .
            t('Once your download is finished, you must refresh the page to download again. (Provided you have permission)') .
            '<br />' . t('Downloads will not be counted until the file is finished transferring, even though the number may increment when you click.') .
            '<br /><b>' . t('Do not use any download acceleration feature to download the file, or you may lock yourself out of the download.') . '</b>' .
            '</p></div>';
    return $output;
}

function gppa_uc_cart_block_items($variables) {
  $items = $variables['items'];
  $class = $variables['collapsed'] ? 'cart-block-items collapsed' : 'cart-block-items';

  // If there are items in the shopping cart...
  if ($items) {
    $output = '<table class="' . $class . '"><tbody>';

    // Loop through each item.
    $row_class = 'odd';
    foreach ($items as $item) {
      // Add the basic row with quantity, title, and price.
      $output .= '<tr class="' . $row_class . '"><td class="cart-block-item-qty">' . $item['qty'] . '</td>'
                . '<td class="cart-block-item-title">' . $item['title'] . '</td>'
                . '<td class="cart-block-item-price">' . theme('uc_price', array('price' => $item['price'])) . '</td></tr>';

      // Add a row of description if necessary.
      if ($item['desc']) {
        $output .= '<tr class="' . $row_class . '"><td colspan="3" class="cart-block-item-desc">' . $item['desc'] . '</td></tr>';
      }

      // Alternate the class for the rows.
      $row_class = ($row_class == 'odd') ? 'even' : 'odd';
    }

    $output .= '</tbody></table>';
  }
  else {
    // Otherwise display an empty message.
    $output = '<p class="' . $class . ' uc-cart-empty">' . t('There are no products in your shopping cart.') . '</p>';
  }

  return $output;
}

function gppa_uc_cart_block_summary($variables) {
  $item_count = $variables['item_count'];
  $item_text = $variables['item_text'];
  $total = $variables['total'];
  $summary_links = $variables['summary_links'];
  
  
  if ($item_count > 0) {

  // Build the basic table with the number of items in the cart and total.
  $output = '<table class="cart-block-summary"><tbody><tr>'
           . '<td class="cart-block-summary-items">' . $item_text . '</td>'
           . '<td class="cart-block-summary-total"><label>' . t('Total:')
           . '</label> ' . theme('uc_price', array('price' => $total)) . '</td>';
  
  // If there are products in the cart...
//  if ($item_count > 0) {
//    // Add a view cart link.
//    $output .= '<td>'
//             . theme('links', array('links' => $summary_links)) . '</td>';
//  }
  
  $output .= '</tr>';
  $output .= '</tbody></table>';
  } else {
      $output = '';
  }

  return $output;
}